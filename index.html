<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>RANDOM BOX PRIZE</title>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
  <style>
    /* …(pakai CSS kamu yang sekarang aja, aman)… */
  </style>
</head>
<body>
  <!-- …(pakai HTML kamu yang sekarang: banner, formPage, boxPage, dll)… -->

  <!-- tambahkan elemen hasil supaya pesan error keliatan -->
  <div id="hasil" style="margin-top:10px"></div>

<script>
/* =======================
   KONFIG BACKEND (PROXY)
   ======================= */
const API = "https://<PROXY-KAMU>.up.railway.app"; // <-- GANTI dgn URL proxy punyamu

/* Helpers panggil API */
async function apiPost(path, body) {
  const r = await fetch(`${API}${path}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    mode: "cors",
    body: JSON.stringify(body || {})
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { status:"ERROR", msg:`HTTP ${r.status}: ${t}` }; }
}
async function apiGet(path) {
  const r = await fetch(`${API}${path}`, { mode:"cors" });
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { status:"ERROR", msg:`HTTP ${r.status}: ${t}` }; }
}

/* =======================
   VAR & LOGIKA GAME
   ======================= */
let namaUser = "", kodeToken = "";
const hadiahList = [3000,3000,4000,5000,4000,5000,3000,4000,3000];
let hadiahUtama = "", indexDipilih = -1, hadiahLain = [], sudahSpin = false;

function info(msg){ document.getElementById("hasil").innerHTML = `<b style="color:yellow">${msg}</b>`; }

async function spinStart(){
  namaUser = document.getElementById("nama").value.trim();
  kodeToken = document.getElementById("kode").value.trim();
  const btnText = document.getElementById("btnText");
  btnText.innerText = "MEMPROSES"; btnText.classList.add("loading-dots");
  info("");

  if(!namaUser || !kodeToken){
    btnText.innerText = "MULAI VERIFIKASI"; btnText.classList.remove("loading-dots");
    return alert("Isi nama & kode token dulu!");
  }

  const res = await apiPost("/cekDanPakaiToken", { nama:namaUser, kode:kodeToken });

  btnText.innerText = "MULAI VERIFIKASI"; btnText.classList.remove("loading-dots");

  if(res.status === "OK"){
    document.getElementById("formPage").style.display = "none";
    document.getElementById("boxPage").style.display  = "block";
    document.querySelectorAll(".box").forEach(b => { b.innerHTML="🎁"; b.style.pointerEvents="auto"; });
  }else{
    info(res.msg || "Gagal verifikasi");
  }
}

function bukaSemuaBox(){
  const boxes = document.querySelectorAll(".box");
  boxes.forEach((box,i)=>{
    setTimeout(()=>{
      box.classList.add("terbuka");
      box.style.pointerEvents="none";
      if(i===indexDipilih){
        box.classList.add("blink","terbuka");
        box.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100%;line-height:1;padding-top:45px;">
            <div style="font-size:20px;margin-bottom:20px;">🎯</div>
            <div style="font-size:28px;font-weight:bold;">${hadiahUtama}</div>
          </div>`;
      }else{
        const angka = parseInt(hadiahLain[i])||0;
        box.style.background="#FFD700"; box.style.color="black";
        box.innerHTML = `Rp${angka.toLocaleString("id-ID")}`;
      }
    }, i*100);
  });
}

async function pilihBox(el){
  if(sudahSpin) return;
  sudahSpin = true;

  const boxes = document.querySelectorAll(".box");
  indexDipilih = [...boxes].indexOf(el);
  document.getElementById("sfxPutar")?.play();
  el.classList.add("clicked");

  // Ambil 9 hadiah lain dari sheet
  const data = await apiGet("/getSisaHadiah");
  if(Array.isArray(data)){ hadiahLain = data; }
  else { el.classList.remove("clicked"); info(data.msg||"Gagal ambil hadiah"); sudahSpin = false; return; }

  setTimeout(async ()=>{
    el.classList.remove("clicked");
    const h = hadiahList[Math.floor(Math.random()*hadiahList.length)];
    hadiahUtama = `Rp${h.toLocaleString()}`;
    const statusPopup = `MENANG ${hadiahUtama}`;

    await apiPost("/simpanHasil", { nama:namaUser, kode:kodeToken, status:hadiahUtama });

    bukaSemuaBox();
    setTimeout(()=>{
      document.getElementById("popupContent").innerHTML = `
        <img src="https://dpw3m2v9dxyrl.cloudfront.net/498/assets/banner/IND/Logo%20Slot%20Bang%20Jago%20200x90.png?V=1748482602" style="height:70px;margin-bottom:10px;"><br>
        🎉<br><strong>${statusPopup}</strong>
        <div style="margin-top:10px;font-size:14px;color:#555;">SCREENSHOT DAN KLAIM HADIAH MELALUI <b>TELEGRAM</b>.</div>`;
      document.getElementById("popupHadiah").style.display = "flex";
      document.getElementById("sfxWin")?.play();
    }, 2000);
  }, 300);
}

async function tampilkanHistoryGabungan(){
  const user = document.getElementById("nama").value.trim();
  const historyEl = document.getElementById("historyBox");
  const textHistori = document.getElementById("textHistori");

  let dot=0; const intv=setInterval(()=>{ dot=(dot+1)%4; textHistori.innerText="LOADING"+".".repeat(dot); },300);
  document.getElementById("boxArea").style.display="none";

  if(!user){
    clearInterval(intv); textHistori.innerText="CEK HISTORI";
    historyEl.style.display="block"; historyEl.innerHTML="<p style='color:yellow;'>❌ Masukkan nama dulu!</p>"; return;
  }

  const data = await apiGet(`/ambilHistoriGabungan?nama=${encodeURIComponent(user)}`);
  clearInterval(intv); textHistori.innerText="CEK HISTORI";

  if(!data || (!data.member?.length && !data.fake?.length)){
    historyEl.style.display="block"; historyEl.innerHTML="<p style='color:orange;'>⚠️ Tidak ada histori.</p>"; return;
  }

  let html = `
    <div style="margin-bottom:10px;padding:8px;background:linear-gradient(to right,#ffcc00,#ff9900);color:#000;font-weight:bold;border-radius:6px;">
      🥇Kemenangan Mulai dari Rp2.000 - Rp1.000.000 💰
    </div><h3>🎉 Pemenang Hari Ini</h3><ul style="text-align:left;">`;
  (data.member||[]).forEach(r=> html += `<li>🏆 <strong>${r.nama}</strong> Memenangkan <span style="color:gold;">${r.status}</span></li>`);
  (data.fake||[]).forEach(t=>{
    const m=t.match(/(.+?) Memenangkan (Rp .+)/);
    if(m){ html += `<li>🏆 <strong>${m[1]}</strong> Memenangkan <span style="color:gold;">${m[2]}</span></li>`; }
    else { html += `<li>🏆 ${t}</li>`; }
  });
  html += "</ul>";
  historyEl.innerHTML = html; historyEl.style.display="block";
}

function kembaliKeForm(){
  document.getElementById("formPage").style.display="block";
  document.getElementById("boxPage").style.display="none";
  document.getElementById("historyBox").style.display="none";
  document.getElementById("boxArea").style.display="grid";
  document.querySelectorAll(".box").forEach(b=>{
    b.innerHTML="🎁"; b.classList.remove("terbuka","clicked","blink"); b.style.pointerEvents="auto";
    b.style.background="transparent"; b.style.color="white"; b.style.boxShadow=""; b.style.transform="";
  });
  document.getElementById("popupHadiah").style.display="none";
  sudahSpin = false;
}
</script>
</body>
</html>
